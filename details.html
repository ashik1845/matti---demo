<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nearest Events</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(to right, #74ebd5, #acb6e5);
        margin: 0;
        padding: 0;
      }

      h1 {
        text-align: center;
        color: #333;
        margin: 20px 0;
      }

      .radius-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
      }

      .radius-label {
        font-size: 18px;
        margin-right: 10px;
      }

      .slider {
        width: 300px;
      }

      #map {
        width: 100%;
        height: 500px;
        border: 2px solid #ccc;
        border-radius: 10px;
        margin: 20px 0;
      }

      .container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        padding: 20px;
      }

      .card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        transition: 0.3s;
        width: 320px;
        cursor: pointer;
      }

      .card:hover {
        transform: scale(1.05);
      }

      .card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }

      .content {
        padding: 20px;
      }

      .content h2 {
        margin: 0;
        font-size: 22px;
        color: #333;
      }

      .content p {
        color: #555;
      }

      .btn {
        display: inline-block;
        margin: 10px 5px;
        padding: 10px 20px;
        text-decoration: none;
        color: white;
        background: #28a745;
        border-radius: 5px;
        transition: 0.3s;
      }

      .btn:hover {
        background: #218838;
      }

      .distance {
        font-weight: bold;
        color: #007bff;
      }

      .loading {
        text-align: center;
        font-size: 18px;
        color: #666;
        margin-top: 20px;
      }

      .location-info {
        text-align: center;
        margin: 10px 0;
        font-size: 18px;
        color: #444;
      }
    </style>
  </head>

  <body>
    <h1>Nearest Events</h1>

    <div class="location-info" id="locationInfo">Fetching your location...</div>

    <div class="radius-container">
      <label for="radius" class="radius-label"
        >Radius: <span id="radiusValue">50</span> km</label
      >
      <input
        type="range"
        id="radius"
        class="slider"
        min="5"
        max="100"
        step="5"
        value="50"
      />
    </div>

    <div id="map"></div>

    <div class="container" id="eventList"></div>

    <div class="loading" id="loadingMessage">Loading events...</div>

    <script>
      // Haversine formula to calculate distance between two lat/lng points
      function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLng = ((lng2 - lng1) * Math.PI) / 180;

        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLng / 2) *
            Math.sin(dLng / 2);

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
      }

      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 12,
          center: { lat: 12.9716, lng: 77.5946 }, // Default center
        });

        const loadingMessage = document.getElementById("loadingMessage");
        const locationInfo = document.getElementById("locationInfo");

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLat = position.coords.latitude;
              const userLng = position.coords.longitude;

              map.setCenter({ lat: userLat, lng: userLng });

              const userMarker = new google.maps.Marker({
                position: { lat: userLat, lng: userLng },
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                title: "Your Location",
              });

              // Display precise location coordinates
              locationInfo.innerHTML = `Your Location: Latitude: <b>${userLat}</b>, Longitude: <b>${userLng}</b>`;

              // Hide loading message
              loadingMessage.style.display = "none";

              // Display events initially
              displayNearestEvents(map, userLat, userLng);

              // Update events based on radius slider
              document
                .getElementById("radius")
                .addEventListener("input", () => {
                  const radius = parseInt(
                    document.getElementById("radius").value
                  );
                  document.getElementById("radiusValue").innerText = radius;
                  displayNearestEvents(map, userLat, userLng, radius);
                });
            },
            (error) => {
              locationInfo.innerHTML =
                "Failed to get location: " + error.message;
            },
            {
              enableHighAccuracy: true, // Ensure high accuracy
              timeout: 10000, // Timeout after 10s
              maximumAge: 0, // No cache
            }
          );
        } else {
          locationInfo.innerHTML =
            "Geolocation is not supported by this browser.";
        }
      }

      function displayNearestEvents(map, userLat, userLng, radius = 50) {
        const events = JSON.parse(localStorage.getItem("events")) || [];

        const nearestEvents = events
          .map((event, index) => {
            const [lat, lng] = event.coordinates
              .replace("Latitude: ", "")
              .replace("Longitude: ", "")
              .split(", ")
              .map(Number);

            const distance = getDistance(userLat, userLng, lat, lng);

            return { ...event, distance, index, lat, lng };
          })
          .filter((event) => event.distance <= radius)
          .sort((a, b) => a.distance - b.distance);

        const eventList = document.getElementById("eventList");
        eventList.innerHTML = "";

        nearestEvents.forEach((event) => {
          const eventCard = document.createElement("div");
          eventCard.classList.add("card");

          eventCard.innerHTML = `
        <img src="${event.image}" alt="${event.name}">
        <div class="content">
          <h2>${event.name}</h2>
          <p>${event.description}</p>
          <p class="distance">Distance: ${event.distance.toFixed(2)} km</p>
          <a href="${
            event.formLink
          }" target="_blank" class="btn">Google Form</a>
          <a href="payment.html?eventIndex=${event.index}" class="btn">Pay â‚¹${
            event.amount
          }</a>
        </div>
      `;
          eventList.appendChild(eventCard);
        });
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcU14_EJ1MaxgQhC35A-ptE4-sCQ1QgMA&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>